<%# 
  MODA STUDIO - Header Component
  Rebuilt with clean design, no border/shadow artifacts
%>
<header class="moda-header" id="modaHeader">
    <div class="container">
        <div class="moda-header__inner">
            <!-- Logo -->
            <a class="moda-header__brand" href="/">
                <span class="moda-header__brand-text">MODA STUDIO</span>
            </a>

            <!-- Mobile Toggle -->
            <button class="moda-header__toggle" type="button" id="navToggle" 
                aria-controls="navMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="moda-header__toggle-bar"></span>
                <span class="moda-header__toggle-bar"></span>
                <span class="moda-header__toggle-bar"></span>
            </button>

            <!-- Navigation Menu -->
            <nav class="moda-header__nav" id="navMenu">
                <ul class="moda-header__menu">
                    <li class="moda-header__menu-item">
                        <a class="moda-header__menu-link" href="/#collections">Bộ sưu tập</a>
                    </li>
                    <li class="moda-header__menu-item">
                        <a class="moda-header__menu-link" href="/products">Sản phẩm</a>
                    </li>
                    <li class="moda-header__menu-item">
                        <a class="moda-header__menu-link" href="/#stories">Câu chuyện</a>
                    </li>
                    <li class="moda-header__menu-item">
                        <a class="moda-header__menu-link" href="/#shop">Cửa hàng</a>
                    </li>
                </ul>
            </nav>

            <!-- Actions -->
            <div class="moda-header__actions">
                <% if (currentUser) { %>
                    <!-- Logged In User Dropdown -->
                    <div class="moda-dropdown" id="userDropdown">
                        <button class="moda-header__user-btn" type="button" id="userDropdownBtn"
                            aria-haspopup="true" aria-expanded="false">
                            <span class="moda-header__user-avatar">
                                <%= (currentUser.username || currentUser.email || 'U').charAt(0).toUpperCase() %>
                            </span>
                            <span class="moda-header__user-name d-none d-md-inline">
                                <%= currentUser.username || currentUser.email %>
                            </span>
                            <i class="bi bi-chevron-down moda-header__user-arrow"></i>
                        </button>
                        <div class="moda-dropdown__menu" id="userDropdownMenu">
                            <div class="moda-dropdown__header">
                                <i class="bi bi-person-circle"></i>
                                <span><%= currentUser.email %></span>
                            </div>
                            <div class="moda-dropdown__divider"></div>
                            <a class="moda-dropdown__item" href="/user/profile/<%= currentUser.id %>">
                                <i class="bi bi-person"></i>
                                <span>Thông tin tài khoản</span>
                            </a>
                            <% const userRoleId = Number(currentUser.roleId); %>
                            <% if (userRoleId === 1 || userRoleId === 2 || userRoleId === 4 || userRoleId === 0) { %>
                                <a class="moda-dropdown__item" href="/admin/dashboard">
                                    <i class="bi bi-speedometer2"></i>
                                    <span>Trang quản trị</span>
                                </a>
                            <% } %>
                            <div class="moda-dropdown__divider"></div>
                            <form action="/logout" method="POST" class="m-0">
                                <button type="submit" class="moda-dropdown__item moda-dropdown__item--danger">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span>Đăng xuất</span>
                                </button>
                            </form>
                        </div>
                    </div>
                <% } else { %>
                    <!-- Guest Actions -->
                    <a class="moda-header__btn moda-header__btn--ghost" href="/signin">
                        <i class="bi bi-person"></i>
                        <span>Đăng nhập</span>
                    </a>
                    <a class="moda-header__btn moda-header__btn--primary" href="/signup">
                        <i class="bi bi-person-plus"></i>
                        <span>Đăng ký</span>
                    </a>
                <% } %>

                <!-- Theme Toggle -->
                <button type="button" class="moda-header__icon-btn" id="themeToggle" 
                    aria-label="Toggle theme" title="Chuyển đổi giao diện">
                    <span class="moda-header__theme-icon moda-header__theme-icon--sun">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                    </span>
                    <span class="moda-header__theme-icon moda-header__theme-icon--moon">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </span>
                </button>

                <!-- Cart Button -->
                <button type="button" class="moda-header__icon-btn moda-header__cart-btn" id="openCartDrawer">
                    <i class="bi bi-bag"></i>
                    <span class="moda-header__cart-badge" id="cartCount">
                        <%= (cartItems && cartItems.length) || 0 %>
                    </span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- Cart Drawer -->
<div class="cart-overlay" id="cartOverlay"></div>
<aside class="cart-drawer" id="cartDrawer">
    <div class="cart-drawer-header">
        <div>
            <h5 class="mb-0 fw-bold">Giỏ hàng</h5>
            <small class="text-muted">
                <span id="cartItemCount"><%= (cartItems && cartItems.length) || 0 %></span> sản phẩm
            </small>
        </div>
        <button type="button" class="btn btn-close-cart" id="closeCartDrawer">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <div class="cart-drawer-body" id="cartDrawerItems">
        <% if (cartItems && cartItems.length > 0) { %>
            <% cartItems.forEach(function(item) { %>
                <div class="cart-item">
                    <div class="cart-item-image">
                        <% if (item.image) { %>
                            <img src="<%= item.image %>" alt="<%= item.name %>">
                        <% } else { %>
                            <i class="bi bi-image"></i>
                        <% } %>
                    </div>
                    <div class="cart-item-details">
                        <h6 class="cart-item-name"><%= item.name %></h6>
                        <% if (item.variantLabel) { %>
                            <small class="text-muted"><%= item.variantLabel %></small>
                        <% } %>
                        <div class="cart-item-price">
                            <span class="qty"><%= item.quantity %> ×</span>
                            <span class="price">
                                <%= item.price.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %>
                            </span>
                        </div>
                    </div>
                    <div class="cart-item-total">
                        <%= (item.price * item.quantity).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="cart-empty">
                <i class="bi bi-bag-x"></i>
                <p>Giỏ hàng trống</p>
                <a href="/products" class="btn btn-outline-dark btn-sm">Xem sản phẩm</a>
            </div>
        <% } %>
    </div>

    <div class="cart-drawer-footer">
        <div class="cart-subtotal">
            <span>Tạm tính</span>
            <strong id="cartSubtotalAmount">
                <%= (cartSubtotal || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }) %>
            </strong>
        </div>
        <button class="btn btn-checkout-drawer" id="checkoutBtn" 
            <% if (!cartItems || !cartItems.length) { %>disabled<% } %>>
            <i class="bi bi-credit-card me-2"></i>Thanh toán
        </button>
        <p class="cart-note">Phí vận chuyển sẽ được tính ở bước thanh toán</p>
    </div>
</aside>

<link rel="stylesheet" href="/css/partials.css">

<script>
    // Cart Drawer functionality
    document.addEventListener("DOMContentLoaded", () => {
        const drawer = document.getElementById("cartDrawer");
        const overlay = document.getElementById("cartOverlay");
        const openBtn = document.getElementById("openCartDrawer");
        const closeBtn = document.getElementById("closeCartDrawer");
        const itemsContainer = document.getElementById("cartDrawerItems");
        const subtotalEl = document.getElementById("cartSubtotalAmount");
        const checkoutBtn = document.getElementById("checkoutBtn");
        const cartCountEl = document.getElementById("cartCount");
        const cartItemCountEl = document.getElementById("cartItemCount");

        if (!drawer || !overlay) return;

        const currencyFormatter = new Intl.NumberFormat("vi-VN", {
            style: "currency",
            currency: "VND",
        });

        const renderCart = (cartPayload) => {
            if (!itemsContainer || !subtotalEl) return;
            const cart = cartPayload && typeof cartPayload === "object" ? cartPayload : {};
            const items = Array.isArray(cart.items) ? cart.items : [];
            const subtotal = Number(cart.subtotal) || 0;

            if (!items.length) {
                itemsContainer.innerHTML = `
                <div class="cart-empty">
                    <i class="bi bi-bag-x"></i>
                    <p>Giỏ hàng trống</p>
                    <a href="/products" class="btn btn-outline-dark btn-sm">Xem sản phẩm</a>
                </div>
            `;
            } else {
                itemsContainer.innerHTML = items.map(item => `
                <div class="cart-item">
                    <div class="cart-item-image">
                        ${item.image ? `<img src="${item.image}" alt="${item.name}">` : '<i class="bi bi-image"></i>'}
                    </div>
                    <div class="cart-item-details">
                        <h6 class="cart-item-name">${item.name}</h6>
                        ${item.variantLabel ? `<small class="text-muted">${item.variantLabel}</small>` : ''}
                        <div class="cart-item-price">
                            <span class="qty">${item.quantity} ×</span>
                            <span class="price">${currencyFormatter.format(Number(item.price) || 0)}</span>
                        </div>
                    </div>
                    <div class="cart-item-total">
                        ${currencyFormatter.format((Number(item.price) || 0) * (Number(item.quantity) || 0))}
                    </div>
                </div>
            `).join("");
            }

            subtotalEl.textContent = currencyFormatter.format(subtotal);
            if (checkoutBtn) checkoutBtn.disabled = items.length === 0;
            if (cartCountEl) cartCountEl.textContent = items.length;
            if (cartItemCountEl) cartItemCountEl.textContent = items.length;
        };

        const openDrawer = () => {
            drawer.classList.add("active");
            overlay.classList.add("active");
            document.body.style.overflow = "hidden";
        };

        const closeDrawer = () => {
            drawer.classList.remove("active");
            overlay.classList.remove("active");
            document.body.style.overflow = "";
        };

        openBtn && openBtn.addEventListener("click", openDrawer);
        closeBtn && closeBtn.addEventListener("click", closeDrawer);
        overlay.addEventListener("click", closeDrawer);

        if (checkoutBtn) {
            checkoutBtn.addEventListener("click", () => {
                if (checkoutBtn.disabled) return;
                window.location.href = "/checkout";
            });
        }

        window.__CART_DRAWER__ = { open: openDrawer, close: closeDrawer, update: renderCart };
        window.addEventListener("cart:updated", (event) => renderCart(event.detail || {}));
        window.addEventListener("cart:open", openDrawer);
    });
</script>

<script>
    // Mobile Navigation Toggle
    document.addEventListener("DOMContentLoaded", () => {
        const toggle = document.getElementById("navToggle");
        const nav = document.getElementById("navMenu");
        
        if (toggle && nav) {
            toggle.addEventListener("click", () => {
                const isOpen = toggle.getAttribute("aria-expanded") === "true";
                toggle.setAttribute("aria-expanded", !isOpen);
                nav.classList.toggle("moda-header__nav--open");
                toggle.classList.toggle("moda-header__toggle--active");
            });
        }
    });

    // User Dropdown
    document.addEventListener("DOMContentLoaded", () => {
        const dropdown = document.getElementById("userDropdown");
        const btn = document.getElementById("userDropdownBtn");
        const menu = document.getElementById("userDropdownMenu");
        
        if (dropdown && btn && menu) {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const isOpen = btn.getAttribute("aria-expanded") === "true";
                btn.setAttribute("aria-expanded", !isOpen);
                menu.classList.toggle("moda-dropdown__menu--open");
            });
            
            document.addEventListener("click", () => {
                btn.setAttribute("aria-expanded", "false");
                menu.classList.remove("moda-dropdown__menu--open");
            });
        }
    });

    // Dark Mode Toggle
    document.addEventListener("DOMContentLoaded", () => {
        const themeToggle = document.getElementById("themeToggle");
        if (!themeToggle) return;

        const getCurrentTheme = () => {
            return document.body.classList.contains("theme-dark") ? "dark" : "light";
        };

        const toggleTheme = async () => {
            const currentTheme = getCurrentTheme();
            const newTheme = currentTheme === "dark" ? "light" : "dark";

            themeToggle.classList.add("moda-header__icon-btn--animating");

            document.body.classList.remove(`theme-${currentTheme}`);
            document.body.classList.add(`theme-${newTheme}`);
            document.documentElement.classList.remove(`theme-${currentTheme}`);
            document.documentElement.classList.add(`theme-${newTheme}`);

            localStorage.setItem("theme", newTheme);

            try {
                await fetch("/user/theme", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `theme=${newTheme}`,
                });
            } catch (error) {
                console.log("Theme preference saved locally only");
            }

            setTimeout(() => {
                themeToggle.classList.remove("moda-header__icon-btn--animating");
            }, 500);
        };

        themeToggle.addEventListener("click", toggleTheme);
        themeToggle.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                toggleTheme();
            }
        });
    });
    
    // Apply theme from localStorage immediately
    (function() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
            const bodyTheme = document.body.classList.contains("theme-dark") ? "dark" : "light";
            if (savedTheme !== bodyTheme) {
                document.body.classList.remove("theme-light", "theme-dark");
                document.body.classList.add(`theme-${savedTheme}`);
                document.documentElement.classList.remove("theme-light", "theme-dark");
                document.documentElement.classList.add(`theme-${savedTheme}`);
            }
        }
    })();
</script>