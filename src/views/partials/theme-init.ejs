<%# 
  Theme Initialization Script - MUST be in <head> before any other content
  This blocking script applies the saved theme immediately to prevent flash
%>
<script>
  // Apply theme IMMEDIATELY before page render to prevent flash
  (function() {
    var savedTheme = localStorage.getItem("theme");
    var serverTheme = "<%= theme || 'light' %>";
    
    // Priority: localStorage > server > light (default)
    var themeToApply = savedTheme || serverTheme || "light";
    
    // Apply theme class to <html> element immediately
    // This runs before body is parsed, preventing flash
    document.documentElement.classList.add("theme-" + themeToApply);
    
    // Store the theme to be applied to body later
    window.__INITIAL_THEME__ = themeToApply;
    
    // If localStorage has a different theme than server, sync it
    if (savedTheme && savedTheme !== serverTheme) {
      // Optionally sync to server via beacon (non-blocking)
      try {
        navigator.sendBeacon("/user/theme/sync", new URLSearchParams({ theme: savedTheme }));
      } catch(e) {}
    }
  })();
</script>
<style>
  /* Apply initial theme styles to prevent white flash */
  html.theme-dark {
    background-color: #0d0d11;
    color-scheme: dark;
  }
  html.theme-light {
    background-color: #f5f5f7;
    color-scheme: light;
  }
  /* Navbar dark mode - immediate apply */
  html.theme-dark .navbar-global,
  html.theme-dark .navbar {
    background: #0d0d11 !important;
    border-color: rgba(255, 255, 255, 0.08) !important;
  }
  /* Hide body until theme is applied to prevent flash */
  body:not(.theme-dark):not(.theme-light) {
    visibility: hidden;
  }
</style>
